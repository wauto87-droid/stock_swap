<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* PREMIUM UI V6 */
    :root {
      --primary: #2563eb;
      --primary-dark: #1e40af;
      --success: #16a34a;
      --danger: #dc2626;
      --warning: #ca8a04;
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --text-main: #1f2937;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    * {
      box-sizing: border-box;
      tap-highlight-color: transparent;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      background-color: var(--bg);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
      padding-bottom: 80px;
    }

    /* PREMIUM COMPONENTS */
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 16px;
    }

    header {
      background: var(--card-bg);
      padding: 16px 20px;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .app-title {
      font-weight: 700;
      font-size: 18px;
      color: var(--primary);
      letter-spacing: -0.5px;
    }

    .user-info {
      font-size: 12px;
      color: var(--text-muted);
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      transition: transform 0.2s, opacity 0.3s;
    }

    .card:active {
      transform: scale(0.99);
    }

    .btn {
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    .btn-block {
      width: 100%;
      display: block;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* UTILITIES */
    .hidden {
      display: none !important;
    }

    .flex {
      display: flex;
      align-items: center;
    }

    .space-between {
      justify-content: space-between;
    }

    .mb-2 {
      margin-bottom: 8px;
    }

    .text-center {
      text-align: center;
    }

    /* STATUS BADGES */
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-Requested {
      background: #eff6ff;
      color: var(--primary);
    }

    .status-Approved,
    .status-ISSUED {
      background: #dcfce7;
      color: var(--success);
    }

    .status-Returned-Partial {
      background: #dbeafe;
      color: var(--primary);
    }

    .status-Offset,
    .status-Offset-Full {
      background: #fee2e2;
      color: var(--danger);
    }

    /* TOAST */
    #toast-container {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000;
      pointer-events: none;
      width: 90%;
      max-width: 400px;
    }

    .toast {
      background: rgba(31, 41, 55, 0.95);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      margin-top: 8px;
      text-align: center;
      font-size: 14px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* BATCH BAR */
    #batch-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 12px 16px;
      box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 900;
      transform: translateY(100%);
      transition: transform 0.3s;
    }

    #batch-bar.active {
      transform: translateY(0);
    }

    /* INPUTS */
    .form-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      font-size: 14px;
      color: var(--text-muted);
    }

    input,
    select {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      background: #f9fafb;
    }

    input:focus,
    select:focus {
      border-color: var(--primary);
      background: white;
    }

    /* CHECKBOX */
    .checkmark {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-radius: 6px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      cursor: pointer;
      color: white;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .checkmark.checked {
      background: var(--primary);
      border-color: var(--primary);
    }

    /* APP SHELL V7 */
    body {
      padding-bottom: 80px;
    }

    /* Space for Bottom Nav */

    /* BOTTOM NAVIGATION */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      padding: 8px 0;
      z-index: 900;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      /* Subtle shadow up */
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 10px;
      font-weight: 500;
      padding: 4px;
      cursor: pointer;
      flex: 1;
      transition: color 0.2s;
    }

    .nav-item.active {
      color: var(--primary);
    }

    .nav-icon {
      font-size: 20px;
      margin-bottom: 2px;
    }

    /* SEARCH INPUT */
    .search-container {
      position: relative;
    }

    input[list] {
      padding-right: 30px;
      /* Space for icon */
    }

    .search-icon {
      position: absolute;
      right: 12px;
      top: 12px;
      color: var(--text-muted);
      pointer-events: none;
    }

    /* CUSTOM DROPDOWN (V10) */
    .dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--border);
      border-radius: 0 0 8px 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      max-height: 250px;
      overflow-y: auto;
      z-index: 1000;
      margin-top: 2px;
    }

    .dropdown-item {
      padding: 10px 12px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-main);
    }

    .dropdown-item:active,
    .dropdown-item:hover {
      background: #f5f5f5;
    }

    .dropdown-item:last-child {
      border-bottom: none;
    }

    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4);
      cursor: pointer;
      transition: transform 0.2s;
      z-index: 1000;
      border: none;
    }

    .fab:active {
      transform: scale(0.9);
    }

    /* CART LIST */
    .cart-item {
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .cart-item:last-child {
      border-bottom: none;
    }

    /* MODAL */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      width: 100%;
      max-width: 600px;
      border-radius: 12px;
      padding: 24px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }

    .close-modal {
      position: absolute;
      top: 16px;
      right: 20px;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-muted);
    }

    .timeline-item {
      padding: 12px 0 12px 16px;
      border-left: 2px solid var(--border);
      position: relative;
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: -5px;
      top: 18px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--primary);
    }

    .timeline-date {
      font-size: 11px;
      color: var(--text-muted);
    }

    .timeline-action {
      font-weight: 600;
      font-size: 14px;
    }

    #login-view {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .section-header {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      margin: 24px 0 12px 0;
      letter-spacing: 0.5px;
    }
  </style>
</head>

<body>
  <div id="toast-container"></div>

  <div id="batch-bar">
    <div id="batch-count" style="font-weight:bold;">0 Selected</div>
    <div class="flex" style="gap:8px;">
      <button class="btn btn-danger" onclick="processBatch('Reject')">Reject All</button>
      <button class="btn btn-success" onclick="processBatch('Approve')">Approve All</button>
    </div>
  </div>

  <div id="login-view" class="container" style="padding-top: 100px;">
    <div class="text-center mb-2">
      <div style="font-size: 32px; font-weight: 800; color: var(--primary);">Stock Swap</div>
      <div style="color: var(--text-muted);">Premium Inventory System</div>
    </div>

    <div class="card">
      <div class="form-group">
        <label>Select Your Name</label>
        <select id="staff-select">
          <option value="">Loading staff...</option>
        </select>
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="staff-pass" placeholder="Enter Password">
      </div>
      <button class="btn btn-primary btn-block" onclick="handleLogin()" id="btn-login">Login</button>
    </div>
  </div>

  <!-- MAIN APP (Wrapped to toggle visibility) -->
  <div id="app-view" class="hidden">
    <header class="flex space-between">
      <div>
        <div class="app-title">Stock Swap</div>
        <div class="user-info" id="user-display">Staff Name ‚Ä¢ Shop</div>
      </div>
      <div>
        <button class="btn btn-secondary" style="padding: 6px 12px;" onclick="showBalances()">Balances</button>
        <button class="btn btn-secondary" style="padding: 6px 12px;" onclick="showHistoryView()">History</button>
        <button class="btn btn-secondary" style="padding: 6px 12px;" onclick="logout()">Logout</button>
      </div>
    </header>

    <div class="container">

      <!-- HISTORY VIEW -->
      <div id="history-view" class="hidden">
        <div class="flex space-between mb-2">
          <h3>Transaction History</h3>
          <button class="btn" onclick="showDashboard()">Back to Dashboard</button>
        </div>
        <div class="card">
          <div id="history-list" style="text-align:center; padding:20px; color:#888;">Loading...</div>
        </div>
      </div>

      <!-- BALANCES VIEW -->
      <div id="balances-view" class="hidden">
        <div class="flex space-between mb-2">
          <h3>Shop Balances</h3>
          <button class="btn" onclick="showDashboard()">Back to Dashboard</button>
        </div>

        <div class="card">
          <div id="balances-list" style="text-align:center; padding:20px; color:#888;">Loading...</div>
        </div>
      </div>

      <!-- DASHBOARD -->
      <div id="dashboard-view">

        <div class="section-header">Needs Your Approval (Incoming)</div>
        <div id="incoming-list">
          <div style="text-align: center; color: #999; padding: 20px;">No pending requests</div>
        </div>

        <div class="section-header">My Pending Requests (Waiting)</div>
        <div id="pending-list">
          <div style="text-align: center; color: #999; padding: 20px;">No outgoing pending requests</div>
        </div>

        <div class="section-header">Active Swaps (Needs Return)</div>
        <div id="active-swaps-list">
          <div style="text-align: center; color: #999; padding: 20px;">No active borrows</div>
        </div>

      </div>

      <!-- NEW REQUEST FORM (CART) -->
      <div id="request-view" class="hidden">
        <div class="flex space-between mb-2">
          <h3>New Stock Request</h3>
          <button class="btn" onclick="showDashboard()">Cancel</button>
        </div>

        <div class="card">
          <!-- ADD ITEM FORM -->
          <div class="form-group search-container">
            <label>Product (Type to Search or Add New)</label>
            <div class="flex" style="gap:8px;">
              <div style="position:relative; flex:1;">
                <input type="text" id="product-search" placeholder="e.g. iPhone 15..."
                  onkeyup="handleProductInput(this)" autocomplete="off">
                <!-- CUSTOM DROPDOWN CONTAINER -->
                <div id="search-results" class="dropdown-list hidden"></div>
                <span class="search-icon">üîç</span>
              </div>
              <button class="btn btn-outline" onclick="toggleAddProduct()" title="Add to Database"
                style="width:40px; display: flex; align-items: center; justify-content: center;">‚ûï</button>
            </div>
          </div>

          <!-- MANAGER ONLY: Add New Product to DB -->
          <div id="add-product-section" class="hidden"
            style="margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px dashed #ccc;">
            <div style="font-weight: bold; margin-bottom: 8px; font-size: 13px; color: var(--text-muted);">Add New to
              Official Database</div>
            <!-- V8 SIMPLIFIED: Just Name -->
            <input type="text" id="new-prod-name" placeholder="Product Name">
            <button class="btn btn-success btn-block" style="margin-top: 8px;" onclick="addNewProduct()"
              id="btn-add-prod">Save Product</button>
          </div>

          <div class="form-group">
            <label>Quantity</label>
            <div class="flex">
              <input type="number" id="req-qty" min="1" value="1" style="flex:1;">
              <button class="btn btn-secondary" style="margin-left:8px;" onclick="addToCart()">Add to List</button>
            </div>
          </div>

          <hr style="margin: 16px 0; border: 0; border-top: 1px solid #eee;">

          <!-- CART LIST -->
          <label>Request List</label>
          <div id="cart-container" style="margin-bottom: 16px;">
            <div style="color: #999; font-size: 13px; font-style: italic;">List is empty</div>
          </div>

          <div class="form-group">
            <label>Requesting From</label>
            <div style="padding: 10px; background: #e8eaed; border-radius: 4px;" id="target-shop-display">Shop 2</div>
          </div>

          <button class="btn btn-primary btn-block" onclick="submitCart()" id="btn-submit-order" disabled>Submit Order
            (0)</button>
        </div>
      </div>

    </div>

    <!-- BOTTOM NAVIGATION (V7) -->
    <div class="bottom-nav hidden" id="main-nav">
      <div class="nav-item active" id="nav-home" onclick="showDashboard()">
        <span class="nav-icon">üè†</span>
        <span>Home</span>
      </div>
      <div class="nav-item" id="nav-request" onclick="showRequestForm()">
        <span class="nav-icon">‚ûï</span>
        <span>New Request</span>
      </div>
      <div class="nav-item" id="nav-cart" onclick="showRequestForm()"> <!-- Shortcut to form/cart -->
        <span class="nav-icon">üõí</span>
        <span>Cart <span id="nav-cart-count" style="font-weight:bold;">(0)</span></span>
      </div>
      <div class="nav-item" id="nav-history" onclick="showHistoryView()">
        <span class="nav-icon">üìú</span>
        <span>History</span>
      </div>
      <div class="nav-item" id="nav-balance" onclick="showBalances()">
        <span class="nav-icon">‚öñÔ∏è</span>
        <span>Balances</span>
      </div>
    </div>
  </div>

  <!-- HISTORY MODAL -->
  <div id="history-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <span class="close-modal" onclick="closeHistory()">√ó</span>
      <h3 style="margin-bottom:16px;">Tracking Details</h3>
      <div id="history-loading" style="text-align:center;">Loading...</div>
      <div id="history-timeline"></div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script>
    // --- CONFIGURATION ---
    const API_URL = "https://script.google.com/macros/s/AKfycbym7HcU7yENcExgZPPH6-eaynECL8gN4WzbPbJr4Ig5T-kYztRAezbMVVkJUH0MwGuR/exec";

    // --- API CLIENT (Headless Mode) ---
    async function callApi(action, params) {
      if (API_URL.includes("INSERT_YOUR")) {
        alert("Please deploy the Google Script first and paste the URL into 'API_URL' in index.html");
        throw new Error("API URL not configured");
      }

      // Show Global loading if needed? 
      // For now, specialized spinners handle UI.

      try {
        const response = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify({ action: action, params: params || {} })
          // mode: 'no-cors' // GAS Redirects usually require handling redirect manually or relying on browser following
          // Actually GAS Web App returns 302 to googleusercontent. Fetch follows automatically.
          // However, CORS headers must be present on the FINAL response.
        });

        const json = await response.json();

        if (json.status === 'error') {
          throw new Error(json.message);
        }
        return json.data;

      } catch (e) {
        console.error("API Error:", e);
        throw e;
      }
    }

    var currentUser = null;
    var products = [];
    var cart = [];
    var selectedIds = new Set(); // Batch Selection

    // --- UTILS & TOAST ---
    function showToast(msg) {
      var div = document.createElement('div');
      div.className = 'toast';
      div.innerText = msg;
      document.getElementById('toast-container').appendChild(div);
      setTimeout(function () { div.remove(); }, 3000);
    }

    // --- BATCH LOGIC ---
    function toggleCheck(id) {
      var el = document.querySelector(`.item-check[data-id="${id}"]`);
      if (selectedIds.has(String(id))) {
        selectedIds.delete(String(id));
        el.classList.remove('checked');
      } else {
        selectedIds.add(String(id));
        el.classList.add('checked');
      }
      updateBatchBar();
    }

    function toggleSelectAll() {
      var all = document.querySelectorAll('.item-check');
      var checkAll = document.getElementById('check-all');

      if (selectedIds.size === all.length) {
        selectedIds.clear();
        all.forEach(el => el.classList.remove('checked'));
        checkAll.classList.remove('checked');
      } else {
        selectedIds.clear();
        all.forEach(el => {
          selectedIds.add(el.dataset.id);
          el.classList.add('checked');
        });
        checkAll.classList.add('checked');
      }
      updateBatchBar();
    }

    function updateBatchBar() {
      var bar = document.getElementById('batch-bar');
      var count = document.getElementById('batch-count');

      if (selectedIds.size > 0) {
        bar.classList.add('active');
        count.innerText = selectedIds.size + " Selected";
      } else {
        bar.classList.remove('active');
      }
    }

    function processBatch(action) {
      if (selectedIds.size === 0) return;

      // Optimistic Hide
      selectedIds.forEach(id => {
        var card = document.getElementById('card-' + id);
        if (card) {
          card.style.opacity = '0';
          setTimeout(function () { card.style.display = 'none'; }, 200);
        }
      });
      document.getElementById('batch-bar').classList.remove('active');

      var ids = Array.from(selectedIds);
      selectedIds.clear();

      var data = {
        requestIds: ids,
        action: action,
        staffName: currentUser.name
      };

      callApi('processBatch', data).then(function (res) {
        showToast("Batch " + action + " Done (" + res.success + ")");
        setTimeout(loadDashboard, 1000);
      }).catch(function (e) {
        alert("Batch Error: " + e.message);
        loadDashboard();
      });
    }

    // --- LOADING HELPERS ---
    function setLoading(btnId, isLoading, text) {
      var btn = document.getElementById(btnId);
      if (!btn) return;
      if (isLoading) {
        btn.disabled = true;
        btn.dataset.originalText = btn.innerText;
        btn.innerText = text || "Processing...";
      } else {
        btn.disabled = false;
        btn.innerText = btn.dataset.originalText || "Submit";
      }
    }

    // --- INIT ---
    window.onload = function () {
      // Check LocalStorage
      var cachedUser = localStorage.getItem('stock_swap_user');
      if (cachedUser) {
        try {
          currentUser = JSON.parse(cachedUser);
          initApp(currentUser);
        } catch (e) { localStorage.removeItem('stock_swap_user'); }
      }

      // Load Staff List
      callApi('getStaffList').then(populateStaff).catch(e => {
        alert("Failed to load staff (API): " + e.message);
      });
    };

    function populateStaff(staffList) {
      var select = document.getElementById('staff-select');
      select.innerHTML = '<option value="">Select User...</option>';
      staffList.forEach(obj => {
        var opt = document.createElement('option');
        opt.value = obj.id;
        opt.textContent = obj.name + ' (' + obj.shop + ')';
        select.appendChild(opt);
      });
    }

    // --- NAVIGATION ---
    function handleLogin() {
      var staffId = document.getElementById('staff-select').value;
      var pass = document.getElementById('staff-pass').value;

      if (!staffId) return alert('Please select a user');
      if (!pass) return alert('Enter password');

      setLoading('btn-login', true, "Logging in...");

      callApi('login', { id: staffId, password: pass }).then(function (user) {
        localStorage.setItem('stock_swap_user', JSON.stringify(user));
        initApp(user);
        setLoading('btn-login', false);
      }).catch(function (e) {
        alert("Login failed: " + e.message);
        setLoading('btn-login', false);
      });
    }

    function initApp(user) {
      currentUser = user;
      document.getElementById('login-view').classList.add('hidden');
      document.getElementById('app-view').classList.remove('hidden');
      document.getElementById('user-display').textContent = user.name + ' ‚Ä¢ ' + user.role + ' ‚Ä¢ ' + user.shop;

      var otherShop = (user.shop === 'Shop1') ? 'Shop2' : 'Shop1';
      document.getElementById('target-shop-display').textContent = "Requesting from: " + otherShop;

      loadDashboard();
      loadProducts();
    }

    function logout() {
      localStorage.removeItem('stock_swap_user');
      currentUser = null;
      document.getElementById('login-view').classList.remove('hidden');
      document.getElementById('app-view').classList.add('hidden');
      document.getElementById('staff-pass').value = '';
      document.getElementById('main-nav').classList.add('hidden'); // Hide Nav
    }

    function updateNav(activeId) {
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      document.getElementById(activeId).classList.add('active');
      document.getElementById('main-nav').classList.remove('hidden');
    }

    function showDashboard() {
      document.getElementById('dashboard-view').classList.remove('hidden');
      document.getElementById('request-view').classList.add('hidden');
      document.getElementById('balances-view').classList.add('hidden');
      document.getElementById('history-view').classList.add('hidden');
      updateNav('nav-home');
      loadDashboard();
    }

    function showBalances() {
      document.getElementById('dashboard-view').classList.add('hidden');
      document.getElementById('request-view').classList.add('hidden');
      document.getElementById('balances-view').classList.remove('hidden');
      document.getElementById('history-view').classList.add('hidden');
      updateNav('nav-balance');
      loadBalances();
    }

    function showHistoryView() {
      document.getElementById('dashboard-view').classList.add('hidden');
      document.getElementById('request-view').classList.add('hidden');
      document.getElementById('balances-view').classList.add('hidden');
      document.getElementById('history-view').classList.remove('hidden');
      updateNav('nav-history');
      loadHistory();
    }

    function showRequestForm() {
      document.getElementById('dashboard-view').classList.add('hidden');
      document.getElementById('request-view').classList.remove('hidden');
      document.getElementById('balances-view').classList.add('hidden');
      document.getElementById('history-view').classList.add('hidden');
      updateNav('nav-request');

      // Reset form but KEEP cart
      document.getElementById('req-qty').value = 1;
      // Focus on search
      setTimeout(() => document.getElementById('product-search').focus(), 300);
    }

    // --- DASHBOARD ---
    function loadDashboard() {
      document.getElementById('incoming-list').innerHTML = '<div style="text-align:center;">Loading...</div>';
      document.getElementById('pending-list').innerHTML = '<div style="text-align:center;">Loading...</div>';
      document.getElementById('active-swaps-list').innerHTML = '<div style="text-align:center;">Loading...</div>';

      callApi('getDashboardData', { staffId: currentUser.id }).then(renderDashboard).catch(function (e) {
        var errHtml = '<div style="text-align:center; color:red; padding:20px;">Error: ' + e.message + '</div>';
        document.getElementById('incoming-list').innerHTML = errHtml;
        document.getElementById('pending-list').innerHTML = errHtml;
        document.getElementById('active-swaps-list').innerHTML = errHtml;
      });
    }

    function renderDashboard(data) {
      try {
        if (data.error) {
          var errHtml = '<div style="text-align:center; color:red; padding:20px;">' + data.error + '</div>';
          document.getElementById('incoming-list').innerHTML = errHtml;
          document.getElementById('pending-list').innerHTML = errHtml;
          document.getElementById('active-swaps-list').innerHTML = errHtml;
          return;
        }

        // 1. Incoming (Action Required)
        var incomingHtml = '';
        if (data.incomingPoints.length === 0) {
          incomingHtml = '<div style="text-align: center; color: #999; padding: 20px;">No pending requests</div>';
        } else {
          // Add Select All header
          incomingHtml += `<div class="flex space-between mb-2">
            <div class="flex" onclick="toggleSelectAll()">
                <div class="checkmark" id="check-all"></div>
                <span style="font-size:13px; font-weight:600;">Select All</span>
            </div>
            <span style="font-size:12px; color:#666;">${data.incomingPoints.length} items</span>
          </div>`;

          data.incomingPoints.forEach(req => {
            incomingHtml += `
                <div class="card" id="card-${req.id}">
                    <div class="flex" style="align-items: flex-start;">
                         <!-- Checkbox -->
                         <div class="checkmark item-check" data-id="${req.id}" onclick="toggleCheck('${req.id}')">‚úì</div>
                         
                         <div style="flex:1;">
                             <div class="flex space-between">
                                 <div class="card-title">${req.name}</div>
                                 <button class="btn btn-outline" style="padding:2px 8px; font-size:10px;" onclick="showHistory('${req.id}')">Track</button>
                             </div>
                             <div class="card-meta">
                                Qty: <b>${req.reqQty}</b> ‚Ä¢ From ${req.reqBy}
                             </div>
                             <div class="flex" style="gap: 8px;">
                                <button class="btn btn-success" style="flex:1; padding:8px;" onclick="processApproval('${req.id}', 'Approve')">Approve</button>
                                <button class="btn btn-danger" style="padding:8px;" onclick="processApproval('${req.id}', 'Reject')">Reject</button>
                             </div>
                         </div>
                    </div>
                </div>`;
          });
        }
        document.getElementById('incoming-list').innerHTML = incomingHtml;

        // 2. Sent Pending (Observation)
        var pendingHtml = '';
        if (data.sentPending.length === 0) {
          pendingHtml = '<div style="text-align: center; color: #999; padding: 20px;">No outgoing pending requests</div>';
        } else {
          data.sentPending.forEach(req => {
            pendingHtml += `
                <div class="card" id="card-${req.id}" style="background: #fffdf5; border-left: 4px solid #fbbc04;">
                    <div class="flex space-between">
                        <div class="card-title">${req.name}</div>
                        <span class="status-badge status-Requested">Pending</span>
                    </div>
                    <div class="card-meta">
                         Sent to ${req.toShop}<br>
                         Qty: ${req.reqQty}
                    </div>
                    <button class="btn btn-outline btn-block" onclick="showHistory('${req.id}')">üëÅÔ∏è Track Status</button>
                </div>`;
          });
        }
        document.getElementById('pending-list').innerHTML = pendingHtml;

        // 3. Active Borrows (Return Action)
        var activeHtml = '';
        if (data.activeBorrows.length === 0) {
          activeHtml = '<div style="text-align: center; color: #999; padding: 20px;">No active borrows</div>';
        } else {
          data.activeBorrows.forEach(req => {
            activeHtml += `
                <div class="card" id="card-${req.id}">
                    <div class="flex space-between">
                        <div class="card-title">${req.name}</div>
                        <span class="status-badge status-${req.status}">${req.status}</span>
                    </div>
                    <div class="card-meta">
                        Approved: ${req.appQty} items ‚Ä¢ From: ${req.toShop}
                    </div>
                    <div class="flex" style="gap: 8px;">
                         <input type="number" id="ret-qty-${req.id}" placeholder="Return Qty" style="width: 100px;">
                         <button class="btn btn-primary" style="flex:1;" id="btn-return-${req.id}" onclick="submitReturn('${req.id}')">Return Items</button>
                    </div>
                </div>`;
          });
        }
        document.getElementById('active-swaps-list').innerHTML = activeHtml;

      } catch (e) {
        alert("Client Render Error: " + e.message);
      }
    }

    // --- SEARCH CART LOGIC REMOVED (Replaced above) ---
    /* Old addToCart removed */

    function removeItem(index) {
      cart.splice(index, 1);
      updateCartUI();
    }

    function updateCartUI() {
      var div = document.getElementById('cart-container');
      var btn = document.getElementById('btn-submit-order');

      if (cart.length === 0) {
        div.innerHTML = '<div style="color: #999; font-size: 13px; font-style: italic;">List is empty</div>';
        btn.innerText = "Submit Order (0)";
        btn.disabled = true;
        return;
      }

      var html = '';
      cart.forEach((item, idx) => {
        html += `
            <div class="cart-item">
                <div>
                   <div style="font-weight:500;">${item.name}</div>
                   <div style="font-size:12px; color:#666;">Qty: ${item.qty}</div>
                </div>
                <button class="btn btn-danger" style="padding:4px 8px; font-size:12px;" onclick="removeItem(${idx})">√ó</button>
            </div>`;
      });
      div.innerHTML = html;
      btn.innerText = "Submit Order (" + cart.length + ")";
      btn.disabled = false;

      // Update Nav Badge
      var badge = document.getElementById('nav-cart-count');
      if (badge) badge.innerText = "(" + cart.length + ")";
    }

    function submitCart() {
      if (cart.length === 0) return;
      // Silent Submit - No Confirm

      setLoading('btn-submit-order', true);

      var otherShop = (currentUser.shop === 'Shop1') ? 'Shop2' : 'Shop1';
      var requests = cart.map(item => ({
        fromShop: currentUser.shop,
        toShop: otherShop,
        productCode: item.code,
        productName: item.name,
        qty: item.qty,
        staffName: currentUser.name
      }));

      callApi('submitRequest', { requests: requests }).then(function () {
        showToast("Requests Submitted!");
        setLoading('btn-submit-order', false);
        showDashboard();
        cart = [];
        updateCartUI();
      }).catch(function (e) {
        showToast("Error: " + e.message);
        setLoading('btn-submit-order', false);
      });
    }

    // --- ACTIONS ---
    function toggleAddProduct() {
      var sec = document.getElementById('add-product-section');
      if (sec.classList.contains('hidden')) {
        sec.classList.remove('hidden');
      } else {
        sec.classList.add('hidden');
      }
    }

    function addNewProduct() {
      var name = document.getElementById('new-prod-name').value;
      // V8 Simplified: No Category
      if (!name) return alert("Enter name");

      setLoading('btn-add-prod', true);

      callApi('addProduct', { staffId: currentUser.id, name: name }).then(function () {
        showToast("Product Added to DB");
        document.getElementById('new-prod-name').value = '';
        document.getElementById('add-product-section').classList.add('hidden');
        setLoading('btn-add-prod', false);
        selectProduct(name);
      }).catch(function (e) {
        alert("Error: " + e.message);
        setLoading('btn-add-prod', false);
      });
    }

    // --- SEARCH LOGIC V8 (Server Side) ---
    // --- SEARCH LOGIC V10 (Custom Dropdown) ---
    var searchTimer = null;

    function handleProductInput(input) {
      var query = input.value;
      var list = document.getElementById('search-results');

      if (!query || query.length < 2) {
        list.classList.add('hidden');
        return;
      }

      // UI Feedback: Show loading
      var icon = document.querySelector('.search-icon');
      if (icon) icon.innerText = "‚è≥";

      clearTimeout(searchTimer);
      clearTimeout(searchTimer);
      searchTimer = setTimeout(function () {
        callApi('searchProducts', { query: query }).then(function (results) {
          products = results;
          list.innerHTML = '';

          if (results.length > 0) {
            results.forEach(p => {
              var div = document.createElement('div');
              div.className = 'dropdown-item';
              div.innerText = p.name;
              div.onclick = function () { selectProduct(p.name); };
              list.appendChild(div);
            });
            list.classList.remove('hidden');
          } else {
            list.innerHTML = '<div class="dropdown-item" style="color:#999; font-style:italic;">No matches. Type to Add New.</div>';
            list.classList.remove('hidden');
          }

          if (icon) icon.innerText = "üîç";
        }).catch(function () {
          if (icon) icon.innerText = "‚ö†Ô∏è";
        });
      }, 300);
    }

    function selectProduct(name) {
      document.getElementById('product-search').value = name;
      document.getElementById('search-results').classList.add('hidden');
      // Optional: Jump to Qty
      document.getElementById('req-qty').focus();
    }

    // Close dropdown if clicked outside
    document.addEventListener('click', function (e) {
      var searchContainer = document.querySelector('.search-container');
      var list = document.getElementById('search-results');
      if (list && !list.classList.contains('hidden') && !searchContainer.contains(e.target)) {
        list.classList.add('hidden');
      }
    });

    // --- CART LOGIC V7 (Smart Search) ---
    // (Previous duplicate V7 header removed by overwrite if present)
    // (Unified Search Logic above)

    function addToCart() {
      var prodName = document.getElementById('product-search').value.trim();
      var qty = document.getElementById('req-qty').value;

      if (!prodName) return showToast("Enter product name");
      if (qty <= 0) return showToast("Invalid Qty");

      // Find Existing Code
      var prodCode = "NEW-" + prodName.toUpperCase().replace(/\s+/g, '-');
      var existing = products.find(p => p.name.toLowerCase() === prodName.toLowerCase());

      if (existing) {
        prodCode = existing.code;
        prodName = existing.name; // Use official casing
      } else {
        // New Item Logic: Just add it!
        // No prompt needed as per user request
      }

      cart.push({
        code: prodCode,
        name: prodName,
        qty: qty
      });

      updateCartUI();

      // Reset
      document.getElementById('product-search').value = "";
      document.getElementById('req-qty').value = 1;
      document.getElementById('product-search').focus();

      // Update Nav Badge
      var badge = document.getElementById('nav-cart-count');
      if (badge) badge.innerText = "(" + cart.length + ")";
    }

    function processApproval(reqId, action) {
      // Silent Action - No Confirm
      // Optimistic UI: Hide card immediately
      var card = document.getElementById('card-' + reqId);
      if (card) {
        card.style.opacity = '0';
        setTimeout(function () { card.style.display = 'none'; }, 200);
        // Remove from batch if exists
        if (selectedIds.has(String(reqId))) toggleCheck(reqId);
      }

      var data = {
        requestId: reqId,
        action: action,
        approvedQty: -1, // Auto-Detect in backend
        staffName: currentUser.name
      };

      google.script.run.withSuccessHandler(function () {
        showToast(action + " Successful");
      }).withFailureHandler(function (e) {
        showToast("Error: " + e.message); // Show toast instead of alert if possible, or keep alert for errors? 
        // User asked for "no popup message for confirmation". Error alerts are probably okay, but let's try toast first.
        alert("Error: " + e.message); // Keep alert for errors to be safe
        if (card) {
          card.style.display = 'block';
          card.style.opacity = '1';
        }
        loadDashboard();
      }).processApproval(data);
    }

    function submitReturn(reqId) {
      var qty = document.getElementById('ret-qty-' + reqId).value;
      if (qty <= 0) return showToast("Enter quantity first");

      // Optimistic UI: Hide Return Input immediately
      var btn = document.getElementById('btn-return-' + reqId);
      if (btn) {
        btn.innerText = "Returning...";
        btn.disabled = true;
      }

      var data = {
        requestId: reqId,
        returnQty: qty,
        staffName: currentUser.name,
        notes: "Web App Return"
      };

      google.script.run.withSuccessHandler(function () {
        showToast("Returned Items Successfully");
        setTimeout(loadDashboard, 1000);
      }).withFailureHandler(function (e) {
        showToast("Error: " + e.message);
        if (btn) {
          btn.innerText = "Return";
          btn.disabled = false;
        }
      }).processReturn(data);
    }

    // --- HISTORY TRACKING ---
    function showHistory(reqId) {
      document.getElementById('history-modal').classList.remove('hidden');
      document.getElementById('history-loading').classList.remove('hidden');
      document.getElementById('history-timeline').innerHTML = '';

      google.script.run.withSuccessHandler(renderHistory).getRequestHistory(reqId);
      callApi('getRequestHistory', { requestId: reqId }).then(renderHistory).catch(function (e) {
        document.getElementById('history-timeline').innerHTML = '<div style="color:red; text-align:center;">' + e.message + '</div>';
        document.getElementById('history-loading').classList.add('hidden');
      });
    }

    function renderHistory(history) {
      document.getElementById('history-loading').classList.add('hidden');

      if (history.error) {
        document.getElementById('history-timeline').innerHTML = '<div style="color:red; text-align:center;">' + history.error + '</div>';
        return;
      }

      var html = '';
      if (history.length === 0) {
        html = '<div style="text-align:center; padding:20px;">No history found</div>';
      } else {
        history.forEach(h => {
          // h.date is already string from server
          html += `
                <div class="timeline-item">
                    <div class="timeline-action">${h.action} - <span style="font-weight:normal;">${h.by}</span></div>
                    <div style="font-size:13px; margin-top:2px;">${h.details}</div>
                    <div class="timeline-date">${h.date}</div>
                </div>`;
        });
      }
      document.getElementById('history-timeline').innerHTML = html;
    }

    function closeHistory() {
      document.getElementById('history-modal').classList.add('hidden');
    }

    // --- GLOBAL HISTORY ---
    function loadHistory() {
      document.getElementById('history-list').innerHTML = 'Loading...';
      callApi('getAllTransactions', { staffId: currentUser.id }).then(function (history) {
        if (history.error) return document.getElementById('history-list').innerHTML = history.error;

        if (history.length === 0) {
          document.getElementById('history-list').innerHTML = 'No transactions found.';
          return;
        }

        var html = '';
        history.forEach(h => {
          var color = h.type.includes('Incoming') ? '#34a853' : '#ea4335';
          html += `
                 <div class="card">
                      <div class="flex space-between">
                          <div style="font-weight:bold; color:${color}; margin-right:8px;">${h.type}</div>
                          <div style="font-size:11px; color:#888;">${h.date}</div>
                      </div>
                      <div class="card-meta" style="margin-top:4px;">
                         ${h.product} (Qty: ${h.qty})<br>
                         With: ${h.otherParty}
                      </div>
                      <div class="flex space-between">
                          <span class="status-badge status-${h.status.replace(' ', '-')}">${h.status}</span>
                          <button class="btn btn-outline" style="font-size:12px; padding:4px 8px;" onclick="showHistory('${h.id}')">Details</button>
                      </div>
                 </div>`;
        });
        document.getElementById('history-list').innerHTML = html;
      }).catch(e => {
        document.getElementById('history-list').innerHTML = "Error: " + e.message;
      });
    }

    // --- BALANCES ---
    function loadBalances() {
      document.getElementById('balances-list').innerHTML = 'Loading...';

      callApi('getBalances', { staffId: currentUser.id }).then(function (data) {
        if (data.error) return alert(data.error);

        if (data.length === 0) {
          document.getElementById('balances-list').innerHTML = 'No outstanding balances.';
          return;
        }

        var html = '<table style="width:100%; font-size:14px;">';
        html += '<tr style="text-align:left; color:#888;"><th>Product</th><th style="text-align:right;">I Owe (To Give)</th><th style="text-align:right;">They Owe (To Receive)</th></tr>';

        data.forEach(b => {
          var giveStyle = b.toGive > 0 ? "color:#ea4335; font-weight:bold;" : "color:#ccc;";
          var recvStyle = b.toReceive > 0 ? "color:#34a853; font-weight:bold;" : "color:#ccc;";

          html += `
                  <tr style="border-bottom:1px solid #eee;">
                      <td style="padding:8px 0;">${b.name}</td>
                      <td style="text-align:right; padding:8px 0; ${giveStyle}">${b.toGive}</td>
                      <td style="text-align:right; padding:8px 0; ${recvStyle}">${b.toReceive}</td>
                  </tr>`;
        });
        html += '</table>';
        document.getElementById('balances-list').innerHTML = html;
      }).catch(e => {
        document.getElementById('balances-list').innerHTML = "Error: " + e.message;
      });
    }
  </script>
</body>

</html>